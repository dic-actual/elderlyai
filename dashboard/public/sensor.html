<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Safety Sensor (Client A)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            text-align: center;
        }

        .status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #0f0;
        }

        .data-display {
            font-family: monospace;
            background: #222;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            max-width: 300px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:active {
            background: #444;
        }

        .btn-primary {
            background: #007bff;
            border-color: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            border-color: #bd2130;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
            border-color: #d39e00;
        }

        .btn-reset {
            background: #28a745;
            border-color: #1e7e34;
        }

        .wizard-panel {
            margin-top: 30px;
            border-top: 1px solid #333;
            padding-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .wizard-title {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-align: center;
        }

        .slider-container {
            width: 100%;
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #ccc;
        }

        input[type=range] {
            width: 100%;
            background: #333;
        }
    </style>
</head>

<body>

    <h1>ElderlyAI Sensor Node</h1>
    <div id="connectionStatus" class="status">Disconnected</div>

    <div class="data-display">
        <div class="data-row"><span>X:</span> <span id="accX">0.00</span></div>
        <div class="data-row"><span>Y:</span> <span id="accY">0.00</span></div>
        <div class="data-row"><span>Z:</span> <span id="accZ">0.00</span></div>
        <div class="data-row"><span>Total G:</span> <span id="totalG">0.00</span></div>
        <div class="data-row" style="margin-top: 10px; color: #aaa;"><span>State:</span> <span id="sensorState">IDLE /
                待機中</span></div>
        <hr style="border-color: #444; margin: 10px 0;">
        <div class="data-row"><span>Heat Index:</span> <span id="heatIndexDisplay">--</span>°C</div>
        <div class="data-row"><span id="heatStatus"
                style="width: 100%; text-align: right; font-weight: bold;">NORMAL</span></div>
    </div>

    <div class="wizard-panel" style="border-top: none; margin-top: 0;">
        <div class="wizard-title">Environment Controls</div>

        <div class="slider-container">
            <div class="slider-label"><span>Temperature</span> <span id="tempVal">28°C</span></div>
            <input type="range" id="tempSlider" min="20" max="40" value="28">
        </div>

        <div class="slider-container">
            <div class="slider-label"><span>Humidity</span> <span id="humidVal">50%</span></div>
            <input type="range" id="humidSlider" min="0" max="100" value="50">
        </div>
    </div>

    <button id="btnStart" class="btn-primary">Start Sensor (iOS Permission)</button>

    <div class="wizard-panel">
        <div class="wizard-title">Simulate Events</div>
        <button id="btnFakeFall" class="btn-danger">FAKE FALL</button>
        <button id="btnReset" class="btn-reset">RESET STATUS</button>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBaDHw3wz8RziooZP3jXrucTXylLraAYz8",
            authDomain: "elderlyai-hackathon.firebaseapp.com",
            databaseURL: "https://elderlyai-hackathon-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "elderlyai-hackathon",
            storageBucket: "elderlyai-hackathon.firebasestorage.app",
            messagingSenderId: "66215058234",
            appId: "1:66215058234:web:b4f7714b9fff3446d18e03",
            measurementId: "G-D7E7J03ZH9"
        };

        // Initialize Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            document.getElementById('connectionStatus').textContent = "Firebase Initialized";
            document.getElementById('connectionStatus').style.color = "#ffc107";
        } catch (e) {
            console.error("Firebase Init Error:", e);
            document.getElementById('connectionStatus').textContent = "Config Error";
            document.getElementById('connectionStatus').style.color = "red";
        }

        const USER_ID = 'senior_1';

        // Sensor Logic
        let isMonitoring = false;
        const G_THRESHOLD_IMPACT = 25.0; // Requested 25G
        const G_THRESHOLD_STILL = 0.5;   // Requested 0.5G
        const STILL_DURATION = 3000;     // 3 seconds

        let lastImpactTime = 0;
        let potentialFall = false;

        // Environment State
        let currentTemp = 28;
        let currentHumid = 50;
        let currentHeatIndex = 0;
        let lastReportedStatus = 'SAFE';

        function calculateHeatIndex(T, RH) {
            // Simple formula: HeatIndex = T - ((0.55 - 0.0055 * RH) * (T - 14.5))
            // T is in Celsius, RH is percentage (0-100)
            return T - ((0.55 - 0.0055 * RH) * (T - 14.5));
        }

        function updateEnvironment() {
            currentHeatIndex = calculateHeatIndex(currentTemp, currentHumid);

            // UI Updates
            document.getElementById('tempVal').textContent = currentTemp + "°C";
            document.getElementById('humidVal').textContent = currentHumid + "%";
            document.getElementById('heatIndexDisplay').textContent = currentHeatIndex.toFixed(1);

            const statusEl = document.getElementById('heatStatus');
            let envStatus = 'SAFE';

            if (currentHeatIndex > 31) {
                statusEl.textContent = "DANGER (HEAT)";
                statusEl.style.color = "red";
                envStatus = 'HEAT';
            } else if (currentHeatIndex > 28) {
                statusEl.textContent = "WARNING";
                statusEl.style.color = "yellow";
                envStatus = 'SAFE'; // Warning is a safe state but visible
            } else {
                statusEl.textContent = "NORMAL";
                statusEl.style.color = "#0f0";
                envStatus = 'SAFE';
            }

            // Report if status changes to HEAT or back to SAFE (if not FALL)
            // Priority: FALL > HEAT > SAFE
            if (lastReportedStatus !== 'FALL') {
                if (envStatus === 'HEAT' && lastReportedStatus !== 'HEAT') {
                    updateStatus('HEAT', 'High Heat Index detected.');
                    lastReportedStatus = 'HEAT';
                } else if (envStatus === 'SAFE' && lastReportedStatus === 'HEAT') {
                    updateStatus('SAFE', 'Temperature normalized.');
                    lastReportedStatus = 'SAFE';
                }
            }

            // Sync Environment Data
            if (isMonitoring && db) {
                update(ref(db, 'users/' + USER_ID), {
                    temp: currentTemp,
                    humidity: currentHumid,
                    heat_index: parseFloat(currentHeatIndex.toFixed(1))
                }).catch(console.error);
            }
        }

        function updateStatus(status, message = "") {
            if (!db) return;
            lastReportedStatus = status;

            const updates = {
                status: status,
                lastUpdate: Math.floor(Date.now() / 1000),
                battery: Math.floor(Math.random() * 20) + 80,
                temp: currentTemp,
                humidity: currentHumid,
                heat_index: parseFloat(currentHeatIndex.toFixed(1))
            };
            if (message) updates.ai_message = message;

            update(ref(db, 'users/' + USER_ID), updates)
                .then(() => console.log("Status updated:", status))
                .catch(e => console.error("Update failed:", e));
        }

        // Sliders
        document.getElementById('tempSlider').addEventListener('input', (e) => {
            currentTemp = parseInt(e.target.value);
            updateEnvironment();
        });

        document.getElementById('humidSlider').addEventListener('input', (e) => {
            currentHumid = parseInt(e.target.value);
            updateEnvironment();
        });

        // Initialize Environment
        updateEnvironment();


        function handleMotion(event) {
            if (!event.accelerationIncludingGravity) return;

            const { x, y, z } = event.accelerationIncludingGravity;
            const totalG = Math.sqrt(x * x + y * y + z * z) / 9.8;

            document.getElementById('accX').textContent = (x || 0).toFixed(2);
            document.getElementById('accY').textContent = (y || 0).toFixed(2);
            document.getElementById('accZ').textContent = (z || 0).toFixed(2);
            document.getElementById('totalG').textContent = totalG.toFixed(2);

            // Fall Detection
            if (totalG > G_THRESHOLD_IMPACT) {
                lastImpactTime = Date.now();
                potentialFall = true;
                document.getElementById('sensorState').textContent = "IMPACT DETECTED!";
                document.getElementById('sensorState').style.color = "red";
            }

            if (potentialFall) {
                const timeSinceImpact = Date.now() - lastImpactTime;

                if (timeSinceImpact > STILL_DURATION) {
                    if (totalG < G_THRESHOLD_STILL) {
                        updateStatus('FALL', 'Fall detected by sensor.');
                        potentialFall = false;
                        document.getElementById('sensorState').textContent = "FALL CONFIRMED";
                    } else if (timeSinceImpact > 5000) {
                        potentialFall = false;
                        document.getElementById('sensorState').textContent = "Monitoring...";
                        document.getElementById('sensorState').style.color = "#aaa";
                    }
                }
            }
        }

        // Start Button
        document.getElementById('btnStart').addEventListener('click', async () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const response = await DeviceMotionEvent.requestPermission();
                    if (response === 'granted') {
                        startMonitoring();
                    } else {
                        alert('Permission denied');
                    }
                } catch (e) {
                    console.error(e);
                }
            } else {
                startMonitoring();
            }
        });

        function startMonitoring() {
            window.addEventListener('devicemotion', handleMotion);
            isMonitoring = true;
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('sensorState').textContent = "Monitoring...";
            updateEnvironment(); // Send initial data
        }

        // Wizard Buttons
        document.getElementById('btnFakeFall').addEventListener('click', () => {
            updateStatus('FALL', 'Manual trigger: Fall detected.');
        });

        document.getElementById('btnReset').addEventListener('click', () => {
            updateStatus('SAFE', 'System reset.');
            document.getElementById('sensorState').textContent = "Monitoring...";
            document.getElementById('sensorState').style.color = "#aaa";
            potentialFall = false;
            // Also reset environment if needed, but we keep slider values
            updateEnvironment();
        });

    </script>
</body>

</html>